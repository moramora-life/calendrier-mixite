const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSlXIsjALEYwBr5Beuw4L7cxsgLrlWDUMifLFd7Gy-lgtOV_t9hzTaOsOoK87hGigHJcr6Y7vlxY13a/pub?gid=153886035&single=true&output=csv";

function toggleView(view) {
  document.getElementById('galleryView').style.display = view === 'gallery' ? 'flex' : 'none';
  document.getElementById('listView').style.display = view === 'list' ? 'flex' : 'none';
  document.getElementById('btnGallery').classList.toggle('active', view === 'gallery');
  document.getElementById('btnList').classList.toggle('active', view === 'list');
}

function csvToArray(str, delimiter = ",") {
  const rows = str.trim().split("\n");
  return rows.map(row => {
    const values = [];
    let inQuotes = false, value = "";
    for (let char of row) {
      if (char === '"') inQuotes = !inQuotes;
      else if (char === delimiter && !inQuotes) {
        values.push(value.trim());
        value = "";
      } else value += char;
    }
    values.push(value.trim());
    return values;
  });
}

function getFormatIcon(format) {
  if (!format) return "";
  const f = format.toLowerCase();
  if (f.includes("visi")) return "💻";
  if (f.includes("présen")) return "👥";
  if (f.includes("hybride")) return "🔁";
  return "";
}

function convertDriveLink(link) {
  const match = link?.match(/[-\w]{25,}/);
  return match ? `https://drive.google.com/uc?export=view&id=${match[0]}` : link;
}

fetch(sheetUrl)
  .then(res => res.text())
  .then(csv => {
    const data = csvToArray(csv);
    const headers = data[0];
    const rows = data.slice(1);

    const now = new Date();
    const gallery = document.getElementById('galleryView');
    const list = document.getElementById('listView');

    const events = rows.map(row => {
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
      return obj;
    }).filter(e => {
      const valid = (e["Validé ?"] || "").toLowerCase() === "oui";
      const date = new Date(e["📆 Date de l’événement"]);
      return valid && !isNaN(date.getTime()) && date >= now;
    });

    events.sort((a, b) => new Date(a["📆 Date de l’événement"]) - new Date(b["📆 Date de l’événement"]));

    events.forEach(e => {
      const imageUrl = convertDriveLink(e["🖼️ Visuel (affiche ou image de l’événement)"]);
      const title = e["📝 Titre de l’événement"];
      const heure = e["🕐 Heure de l’événement"];
      const orga = e["Nom de l'association"];
      const desc = e["📄 Description courte de l’événement"];
      const lieu = e["📍 Adresse de l’événement"];
      const lien = e["Lien vers la page d'inscription"];
      const dateAffichee = e["Date formatée"];
      const format = e["Format"];
      const lieuAffiche = (format && format.toLowerCase() === "hybride") ? `${lieu} + visio` : lieu;
      const formatIcon = getFormatIcon(format);

      const html = `
        <div class="card">
          <img src="${imageUrl}" alt="Visuel de l’événement">
          <div class="card-content">
            <h3>${title} <span class="format-icon">${formatIcon}</span></h3>
            <p><strong>📅</strong> ${dateAffichee} – ${heure}</p>
            <p><strong>📍</strong> ${lieuAffiche}</p>
            <p><strong>👥</strong> ${orga}</p>
            <p>${desc}</p>
            <a href="${lien}" target="_blank">En savoir +</a>
          </div>
        </div>`;

      gallery.innerHTML += html;
      list.innerHTML += html;
    });
  });
