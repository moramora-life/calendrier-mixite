const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSlXIsjALEYwBr5Beuw4L7cxsgLrlWDUMifLFd7Gy-lgtOV_t9hzTaOsOoK87hGigHJcr6Y7vlxY13a/pub?gid=153886035&single=true&output=csv";

function toggleView(view) {
  document.getElementById('galleryView').style.display = view === 'gallery' ? 'flex' : 'none';
  document.getElementById('listView').style.display = view === 'list' ? 'flex' : 'none';
  document.getElementById('btnGallery').classList.toggle('active', view === 'gallery');
  document.getElementById('btnList').classList.toggle('active', view === 'list');
}

function csvToArray(str, delimiter = ",") {
  const rows = str.trim().split("\n");
  return rows.map(row => {
    const values = [];
    let inQuotes = false, value = "";
    for (let char of row) {
      if (char === '"') inQuotes = !inQuotes;
      else if (char === delimiter && !inQuotes) {
        values.push(value.trim());
        value = "";
      } else value += char;
    }
    values.push(value.trim());
    return values;
  });
}

function getFormatIcon(format) {
  if (!format) return "";
  const f = format.toLowerCase();
  if (f.includes("visi")) return "ğŸ’»";
  if (f.includes("prÃ©sen")) return "ğŸ‘¥";
  if (f.includes("hybride")) return "ğŸ”";
  return "";
}

function convertDriveLink(link) {
  const match = link?.match(/[-\w]{25,}/);
  return match ? `https://drive.google.com/uc?export=view&id=${match[0]}` : link;
}

fetch(sheetUrl)
  .then(res => res.text())
  .then(csv => {
    const data = csvToArray(csv);
    const headers = data[0];
    const rows = data.slice(1);

    const now = new Date();
    const gallery = document.getElementById('galleryView');
    const list = document.getElementById('listView');

    const events = rows.map(row => {
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
      return obj;
    }).filter(e => {
      const valid = (e["ValidÃ© ?"] || "").toLowerCase() === "oui";
      const date = new Date(e["ğŸ“† Date de lâ€™Ã©vÃ©nement"]);
      return valid && !isNaN(date.getTime()) && date >= now;
    });

    events.sort((a, b) => new Date(a["ğŸ“† Date de lâ€™Ã©vÃ©nement"]) - new Date(b["ğŸ“† Date de lâ€™Ã©vÃ©nement"]));

    events.forEach(e => {
      const imageUrl = convertDriveLink(e["ğŸ–¼ï¸ Visuel (affiche ou image de lâ€™Ã©vÃ©nement)"]);
      const title = e["ğŸ“ Titre de lâ€™Ã©vÃ©nement"];
      const heure = e["ğŸ• Heure de lâ€™Ã©vÃ©nement"];
      const orga = e["Nom de l'association"];
      const desc = e["ğŸ“„ Description courte de lâ€™Ã©vÃ©nement"];
      const lieu = e["ğŸ“ Adresse de lâ€™Ã©vÃ©nement"];
      const lien = e["Lien vers la page d'inscription"];
      const dateAffichee = e["Date formatÃ©e"];
      const format = e["Format"];
      const lieuAffiche = (format && format.toLowerCase() === "hybride") ? `${lieu} + visio` : lieu;
      const formatIcon = getFormatIcon(format);

      const html = `
        <div class="card">
          <img src="${imageUrl}" alt="Visuel de lâ€™Ã©vÃ©nement">
          <div class="card-content">
            <h3>${title} <span class="format-icon">${formatIcon}</span></h3>
            <p><strong>ğŸ“…</strong> ${dateAffichee} â€“ ${heure}</p>
            <p><strong>ğŸ“</strong> ${lieuAffiche}</p>
            <p><strong>ğŸ‘¥</strong> ${orga}</p>
            <p>${desc}</p>
            <a href="${lien}" target="_blank">En savoir +</a>
          </div>
        </div>`;

      gallery.innerHTML += html;
      list.innerHTML += html;
    });
  });
