<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendrier événements mixité</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fff;
      color: #333;
    }

    .filter-bar {
      position: sticky;
      top: 0;
      z-index: 999;
      background: white;
      padding: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .filter-button, .filter-tag {
      font-size: 1rem;
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: white;
      color: black;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .filter-button::after {
      content: "▼";
      font-size: 0.7rem;
    }

    .filter-tag {
      background: #8e294f;
      color: white;
      border: none;
    }

    .filter-tag button {
      background: none;
      border: none;
      color: white;
      font-size: 1rem;
      margin-left: 0.3rem;
      cursor: pointer;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 1rem;
      gap: 1rem;
    }

    .card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 400px;
    }

    .card-link {
      text-decoration: none;
      color: inherit;
    }

    .card-link img {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
    }

    .card-content {
      padding: 1rem;
    }

    .card-content h3 {
      margin: 0 0 0.5rem;
      font-size: 1.2rem;
    }

    .meta, .tarif, .orga {
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
    }

    .meta.date-time {
      font-weight: bold;
      color: #333;
    }

    .tarif, .orga {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="filter-bar">
    <div id="dateContainer"></div>
    <div id="priceContainer"></div>
  </div>
  <div id="eventContainer" class="container"></div>

  <script>
    const filters = { date: "", price: "" };
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSX69M9TWwSRdV0OQT8kjW436XQHM8VCTg0BBoDDFIfMYavOSImLzx-XjK4rYnCAy7x-kggRyXUWd-m/pub?gid=1245580470&single=true&output=csv";

    const dateOptions = {
      "": "Date", "today": "Aujourd’hui", "tomorrow": "Demain",
      "week": "Cette semaine", "nextWeek": "Semaine suivante",
      "month": "Ce mois-ci", "nextMonth": "Le mois prochain"
    };

    const priceOptions = {
      "": "Prix", "gratuit": "Gratuit", "payant": "Payant"
    };

    function csvToArray(str, delimiter = ",") {
      const rows = str.trim().split("\n");
      return rows.map(row => {
        const values = [];
        let inQuotes = false, value = "";
        for (let char of row) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === delimiter && !inQuotes) {
            values.push(value.trim());
            value = "";
          } else value += char;
        }
        values.push(value.trim());
        return values;
      });
    }

    function parseFrenchDate(str) {
      const [day, month, year] = str.split("/").map(Number);
      return new Date(year, month - 1, day);
    }

    function getDateLabel(date) {
      const now = new Date();
      const tomorrow = new Date(); tomorrow.setDate(now.getDate() + 1);
      if (date.toDateString() === now.toDateString()) return "Aujourd’hui";
      if (date.toDateString() === tomorrow.toDateString()) return "Demain";
      const raw = date.toLocaleDateString("fr-FR", { weekday: 'short', day: 'numeric', month: 'short' });
      return raw.charAt(0).toUpperCase() + raw.slice(1);
    }

    function getFormatIcon(format) {
      if (!format) return "";
      const f = format.toLowerCase();
      if (f.includes("visi")) return "🖥️";
      if (f.includes("hybride")) return "👥🖥️";
      if (f.includes("présen")) return "👥";
      return "";
    }

    function updateFilterDisplay() {
      const dateDiv = document.getElementById("dateContainer");
      const priceDiv = document.getElementById("priceContainer");

      dateDiv.innerHTML = filters.date
        ? `<div class="filter-tag">Date : ${dateOptions[filters.date]}<button onclick="clearFilter('date')">X</button></div>`
        : `<button class="filter-button" onclick="showSelect('date')">${dateOptions[""]}</button>`;

      priceDiv.innerHTML = filters.price
        ? `<div class="filter-tag">Prix : ${priceOptions[filters.price]}<button onclick="clearFilter('price')">X</button></div>`
        : `<button class="filter-button" onclick="showSelect('price')">${priceOptions[""]}</button>`;
    }

    function showSelect(type) {
      const value = prompt(`Choisir ${type === "date" ? "la date" : "le prix"}:\n${Object.entries(type === "date" ? dateOptions : priceOptions).filter(([k]) => k).map(([k, v]) => `${k} = ${v}`).join("\n")}`);
      if (Object.keys(type === "date" ? dateOptions : priceOptions).includes(value)) {
        filters[type] = value;
        render();
      }
    }

    function clearFilter(type) {
      filters[type] = "";
      render();
    }

    fetch(sheetUrl)
      .then(res => res.text())
      .then(csv => {
        const data = csvToArray(csv);
        const headers = data[0];
        const rows = data.slice(1);
        const now = new Date();
        const container = document.getElementById("eventContainer");

        const events = rows.map(row => {
          const e = {};
          headers.forEach((h, i) => e[h.trim()] = row[i]?.trim());
          const date = parseFrenchDate(e["📆 Date de l’événement"]);
          return (e["Publié ?"]?.toLowerCase() === "oui" && !isNaN(date) && date >= now) ? { ...e, date } : null;
        }).filter(Boolean);

        events.sort((a, b) => a.date - b.date);

        window.render = () => {
          updateFilterDisplay();
          container.innerHTML = "";

          const filtered = events.filter(e => {
            const date = e.date;
            const d = filters.date;
            const p = filters.price;

            let matchDate = true;
            if (d) {
              const today = new Date();
              const day = date.toDateString();
              switch (d) {
                case "today": matchDate = day === today.toDateString(); break;
                case "tomorrow": today.setDate(today.getDate() + 1); matchDate = day === today.toDateString(); break;
                case "week":
                  const endWeek = new Date(); endWeek.setDate(today.getDate() + 7);
                  matchDate = date >= today && date <= endWeek; break;
                case "nextWeek":
                  const start = new Date(); start.setDate(today.getDate() + 7);
                  const end = new Date(); end.setDate(start.getDate() + 7);
                  matchDate = date >= start && date <= end; break;
                case "month":
                  const endM = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                  matchDate = date >= today && date <= endM; break;
                case "nextMonth":
                  const s = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                  const eM = new Date(today.getFullYear(), today.getMonth() + 2, 0);
                  matchDate = date >= s && date <= eM; break;
              }
            }

            const matchPrice = !p || (e["Tarif"] || "").toLowerCase() === p;
            return matchDate && matchPrice;
          });

          if (!filtered.length) {
            container.innerHTML = `<p style="text-align:center;margin-top:2rem;">Aucun événement ne correspond à votre recherche. Ajuster les filtres pour explorer d'autres opportunités.</p>`;
            return;
          }

          filtered.forEach(e => {
            const dateLabel = getDateLabel(e.date);
            const formatIcon = getFormatIcon(e["⚙️Format"]);
            const prix = e["Tarif"]?.toLowerCase() === "gratuit" ? "🎟️ Gratuit" : `🎟️ À partir de ${e["Billet à partir de"]}`;

            container.innerHTML += `
              <div class="card">
                <a href="${e["📢 Lien vers la page d'inscription"]}" target="_blank" class="card-link">
                  <img src="${e["Lien Cloudinary"]}" alt="Visuel de l'événement" />
                  <div class="card-content">
                    <h3>${e["📝 Titre de l’événement"]}</h3>
                    <div class="meta date-time">📅 ${dateLabel} à ${e["🕐 Heure"]} – ${formatIcon} ${e["⚙️Format"]}</div>
                    <div class="meta">📍${e["📍 Adresse de l’événement"]}</div>
                    <div class="tarif">${prix}</div>
                    <div class="orga">🔊 ${e["🎓 Association organisatrice"]}</div>
                  </div>
                </a>
              </div>`;
          });
        };

        render();
      });
  </script>
</body>
</html>
