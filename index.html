fetch(sheetUrl)
  .then(res => res.text())
  .then(csv => {
    const data = csvToArray(csv);
    const headers = data[0];
    const rows = data.slice(1);
    const now = new Date();
    const gallery = document.getElementById('galleryView');
    const list = document.getElementById('listView');

    const events = rows.map(row => {
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
      return obj;
    }).filter(e => {
      const published = (e["PubliÃ© ?"] || "").toLowerCase();
      const isValid = published === "oui";
      const [year, month, day] = (e["ğŸ“† Date de lâ€™Ã©vÃ©nement"] || "").split("-").map(n => parseInt(n));
      const date = new Date(year, month - 1, day);
      return isValid && !isNaN(date.getTime()) && date >= now;
    });

    events.sort((a, b) => new Date(a["ğŸ“† Date de lâ€™Ã©vÃ©nement"]) - new Date(b["ğŸ“† Date de lâ€™Ã©vÃ©nement"]));

    events.forEach(e => {
      const imageUrl = extractDriveImage(e["ğŸ–¼ï¸ Visuel de l'Ã©vÃ©nement (format paysage)"]);
      const title = e["ğŸ“ Titre de lâ€™Ã©vÃ©nement"];
      const heure = e["ğŸ• Heure"];
      const orga = e["ğŸ“ Association organisatrice"];
      const desc = e["ğŸ“„ Description courte de lâ€™Ã©vÃ©nement"];
      const lieu = e["ğŸ“ Adresse de lâ€™Ã©vÃ©nement"];
      const lienBrut = e["ğŸ“¢ Lien vers la page d'inscription"];
      const lien = lienBrut.startsWith("http") ? lienBrut : "https://" + lienBrut;
      const dateAffichee = e["Date finale"];
      const format = e["âš™ï¸Format"];
      const lieuAffiche = (format && format.toLowerCase() === "hybride") ? `${lieu} + visio` : lieu;
      const formatIcon = getFormatIcon(format);

      const html = `
        <div class="card">
          <img src="${imageUrl}" alt="Visuel de lâ€™Ã©vÃ©nement">
          <div class="card-content">
            <h3>${title} <span class="format-icon">${formatIcon}</span></h3>
            <p><strong>ğŸ“…</strong> ${dateAffichee} â€“ ${heure}</p>
            <p><strong>ğŸ“</strong> ${lieuAffiche}</p>
            <p><strong>ğŸ‘¥</strong> ${orga}</p>
            <p>${desc}</p>
            <a href="${lien}" target="_blank">En savoir +</a>
          </div>
        </div>`;
      gallery.innerHTML += html;
      list.innerHTML += html;
    });
  });
