fetch(sheetUrl)
  .then(res => res.text())
  .then(csv => {
    const data = csvToArray(csv);
    const headers = data[0];
    const rows = data.slice(1);
    const now = new Date();
    const gallery = document.getElementById('galleryView');
    const list = document.getElementById('listView');

    const events = rows.map(row => {
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
      return obj;
    }).filter(e => {
      const published = (e["Publié ?"] || "").toLowerCase();
      const isValid = published === "oui";
      const [year, month, day] = (e["📆 Date de l’événement"] || "").split("-").map(n => parseInt(n));
      const date = new Date(year, month - 1, day);
      return isValid && !isNaN(date.getTime()) && date >= now;
    });

    events.sort((a, b) => new Date(a["📆 Date de l’événement"]) - new Date(b["📆 Date de l’événement"]));

    events.forEach(e => {
      const imageUrl = extractDriveImage(e["🖼️ Visuel de l'événement (format paysage)"]);
      const title = e["📝 Titre de l’événement"];
      const heure = e["🕐 Heure"];
      const orga = e["🎓 Association organisatrice"];
      const desc = e["📄 Description courte de l’événement"];
      const lieu = e["📍 Adresse de l’événement"];
      const lienBrut = e["📢 Lien vers la page d'inscription"];
      const lien = lienBrut.startsWith("http") ? lienBrut : "https://" + lienBrut;
      const dateAffichee = e["Date finale"];
      const format = e["⚙️Format"];
      const lieuAffiche = (format && format.toLowerCase() === "hybride") ? `${lieu} + visio` : lieu;
      const formatIcon = getFormatIcon(format);

      const html = `
        <div class="card">
          <img src="${imageUrl}" alt="Visuel de l’événement">
          <div class="card-content">
            <h3>${title} <span class="format-icon">${formatIcon}</span></h3>
            <p><strong>📅</strong> ${dateAffichee} – ${heure}</p>
            <p><strong>📍</strong> ${lieuAffiche}</p>
            <p><strong>👥</strong> ${orga}</p>
            <p>${desc}</p>
            <a href="${lien}" target="_blank">En savoir +</a>
          </div>
        </div>`;
      gallery.innerHTML += html;
      list.innerHTML += html;
    });
  });
